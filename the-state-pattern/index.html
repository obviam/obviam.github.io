<!DOCTYPE html>
<html>

    <head>
        <title> Object Composition Strategies - The State Pattern &middot; Obviam - Game Development Tutorials and Musings in Software Development </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.13" />


<script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<link rel="stylesheet" href="https://obviam.github.io/css/nix.css">

 
<link href="https://fonts.googleapis.com/css?family=Inconsolata|Open+Sans|Roboto|Montserrat|Concert+One|Source+Code+Pro:400,700" rel="stylesheet">



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17403436-1', 'auto');
	  ga('send', 'pageview');

</script>


    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://obviam.github.io/>impaler@obviam.net ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://obviam.github.io/">/home/impaler</a>
				</li>
				
				
				<li >
					<a href="/blog-tmp">~/blog</a>
				</li>
				
				
				<li >
					<a href="/plan">~/.plan</a>
				</li>
				
				
				<li >
					<a href="/archive">~/archive</a>
				</li>
				
				
				<li >
					<a href="/about">~/about</a>
				</li>
				

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="https://obviam.github.io/the-state-pattern">Object Composition Strategies - The State Pattern</a></h1>
            <span class="post-date">Mar 31, 2011 </span>
            <div class="post-content">
                <p>In this part I will try to explain how to design easily extensible and maintainable game elements that control their own internal state and behaviours.</p>

<p>An internal state is best described as being the soul and mind of the entity. In the [first part][1] I described why composition is better than inheritance. In a nutshell composition provides the means to interchange the algorithms associated with their behaviours. State on the other hand helps objects to control their own behaviours.</p>

<p></p>

<p>If you are not familiar with the behaviours and strategies, I strongly suggest to go and check out the [previous article][1] as I will be picking up those droids and make them utterly clever during the next articles. But first we need to take a closer look to how I design less clever entities, like weapons.</p>

<p>Let&rsquo;s design an old fashioned rifle and learn from the process how to design the next gen weapons to fend off the invading droid army.</p>

<p>Breaking it down, what can one do with a rifle? Pull the trigger of course and reload (insert, eject the ammo clip).</p>

<p>Now think of all the scenarios. What happens if I pull the trigger and there is no clip? Or when there is one but it&rsquo;s empty? Apparently a simple thing became a bit more complicated. Let&rsquo;s see it on paper:</p>

<p><img src="/images/archive/2011/03/RifleStateDiagram-e1301593224636.png" alt="Initial Rifle State Diagram" /></p>

<blockquote>
<p>Initial Rifle State Diagram</p>
</blockquote>

<p>Let&rsquo;s examine the diagram and figure out what it is and what is that we want.</p>

<p>The above diagram is called a <strong>State Diagram</strong>.</p>

<p>Each of those circles is a <strong>State</strong> and each of those arrows is a <strong>State Transition</strong>.</p>

<p>Each state is just a different configuration of the rifle. The rifle behaves in certain ways depending in which state it is in and some action is needed to take it to another state. So, to go to another state, you will need to do something like pull the trigger or insert clip. See the arrows on the diagram.</p>

<p>We identify the following <strong>states</strong>:</p>

<ul>
<li>No Clip</li>
<li>Has Clip</li>
<li>Ammo fired</li>
<li>Out of Ammo</li>
</ul>

<p>and <strong>actions (transitions)</strong>:</p>

<ul>
<li>inserts clip</li>
<li>ejects clip</li>
<li>pulls trigger</li>
<li>fire ammo</li>
</ul>

<p>Note: I used third person for 3 of the actions. It is because the <strong>user</strong> of the weapon will trigger these actions while <em>fire ammo</em> is more of an internal action.</p>

<p>The whole thing described above is also called a <strong>Finite State Machine</strong>. It is nothing more than an object that holds a finite number of states that govern behaviour and the object can be in <em>only one</em> state at any given time.</p>

<h4 id="our-first-implementation">Our First Implementation</h4>

<p>Knowing all this, what would be our first choice for the implementation? A class that has all the possible states and actions, right? It should also hold the current state. Simple.</p>

<p>Create the <code>Rifle.java</code> class.</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">Rifle</span> <span style="color: #666666">{</span>

    <span style="color: #60a0b0; font-style: italic">// defining the states</span>
    <span style="color: #007020; font-weight: bold">final</span> <span style="color: #007020; font-weight: bold">static</span> <span style="color: #902000">int</span> NO_CLIP        <span style="color: #666666">=</span> <span style="color: #40a070">0</span><span style="color: #666666">;</span>
    <span style="color: #007020; font-weight: bold">final</span> <span style="color: #007020; font-weight: bold">static</span> <span style="color: #902000">int</span> HAS_CLIP       <span style="color: #666666">=</span> <span style="color: #40a070">1</span><span style="color: #666666">;</span>
    <span style="color: #007020; font-weight: bold">final</span> <span style="color: #007020; font-weight: bold">static</span> <span style="color: #902000">int</span> AMMO_FIRED     <span style="color: #666666">=</span> <span style="color: #40a070">2</span><span style="color: #666666">;</span>
    <span style="color: #007020; font-weight: bold">final</span> <span style="color: #007020; font-weight: bold">static</span> <span style="color: #902000">int</span> OUT_OF_AMMO    <span style="color: #666666">=</span> <span style="color: #40a070">3</span><span style="color: #666666">;</span>
    
    <span style="color: #902000">int</span> state <span style="color: #666666">=</span> NO_CLIP<span style="color: #666666">;</span>    <span style="color: #60a0b0; font-style: italic">// instance variable holding the current state</span>
    <span style="color: #902000">int</span> ammoCount <span style="color: #666666">=</span> <span style="color: #40a070">0</span><span style="color: #666666">;</span>      <span style="color: #60a0b0; font-style: italic">// we count the ammo</span>
<span style="color: #666666">}</span>
</pre></div>

<p>Great! We created the structure of the rifle. We also want to know when we are out of ammo, so we added the <code>ammoCount</code> variable. They are set to default values. The rifle holds no clip thus the ammo is 0 when it is created.</p>

<p>Now let&rsquo;s add the actions. But beware! Exposing all the actions to someone handling the weapon is dangerous. What will happen when someone tries to pull out the clip while firing? We need to take these into consideration when triggering the actions.</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #60a0b0; font-style: italic">// **********************</span>
<span style="color: #60a0b0; font-style: italic">// Creating the actions</span>
<span style="color: #60a0b0; font-style: italic">// **********************</span>

<span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">insertClip</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #60a0b0; font-style: italic">// We check each possible state and act according to them</span>
    <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> HAS_CLIP<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;There is already a clip loaded.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> AMMO_FIRED<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;You&#39;ll hurt yourself!!!&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> OUT_OF_AMMO<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;You need to take out the empty clip first.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> NO_CLIP<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        state <span style="color: #666666">=</span> HAS_CLIP<span style="color: #666666">;</span>
        ammoCount <span style="color: #666666">=</span> <span style="color: #40a070">10</span><span style="color: #666666">;</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;You have loaded a clip with &quot;</span> <span style="color: #666666">+</span> ammoCount <span style="color: #666666">+</span> <span style="color: #4070a0">&quot; bulletts.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>

<span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">ejectClip</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> NO_CLIP<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;The magazine is empty.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> AMMO_FIRED<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;You&#39;ll hurt yourself!!!&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> HAS_CLIP<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #60a0b0; font-style: italic">// You could still eject it if you want but for the sake of</span>
        <span style="color: #60a0b0; font-style: italic">// simplicity let&#39;s use up the ammo first</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;Use up all your ammo first.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> OUT_OF_AMMO<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        state <span style="color: #666666">=</span> NO_CLIP<span style="color: #666666">;</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;You have unloaded a clip.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>

<span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">pullTrigger</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> NO_CLIP<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;Empty Click!&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> AMMO_FIRED<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;Jammed!&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> OUT_OF_AMMO<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;Click! Out of ammo.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> HAS_CLIP<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;BANG!!!&quot;</span><span style="color: #666666">);</span>
        state <span style="color: #666666">=</span> AMMO_FIRED<span style="color: #666666">;</span>
        fireAmmo<span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>

<span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">fireAmmo</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> NO_CLIP<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;Empty magazine.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> AMMO_FIRED<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;Bullet already on its way to kill someone!&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> OUT_OF_AMMO<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;Out of ammo.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>state <span style="color: #666666">==</span> HAS_CLIP<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        state <span style="color: #666666">=</span> AMMO_FIRED<span style="color: #666666">;</span>
        ammoCount<span style="color: #666666">--;</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;Bullet on its way!&quot;</span><span style="color: #666666">);</span>
        <span style="color: #60a0b0; font-style: italic">// we check if the clip is empty</span>
        <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>ammoCount <span style="color: #666666">==</span> <span style="color: #40a070">0</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #60a0b0; font-style: italic">// yes, it&#39;s empty</span>
            System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;Darn! Out of ammo&quot;</span><span style="color: #666666">);</span>
            state <span style="color: #666666">=</span> OUT_OF_AMMO<span style="color: #666666">;</span>
        <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #666666">{</span>
            state <span style="color: #666666">=</span> HAS_CLIP<span style="color: #666666">;</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>
</pre></div>

<p>Let&rsquo;s put the rifle to the test.</p>

<p>Create the <code>RifleTest.java</code> class.</p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">RifleTest</span> <span style="color: #666666">{</span>
    
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">static</span> <span style="color: #902000">void</span> <span style="color: #06287e">main</span><span style="color: #666666">(</span>String<span style="color: #666666">[]</span> args<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        Rifle rifle <span style="color: #666666">=</span> <span style="color: #007020; font-weight: bold">new</span> Rifle<span style="color: #666666">();</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span>rifle<span style="color: #666666">);</span>
        
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">insertClip</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span>rifle<span style="color: #666666">);</span>
        
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">insertClip</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">ejectClip</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>
</pre></div>

<p>It is a very simple scripted scenario which performs some actions on the rifle. Some may be good some bad. As when trying to force in a second clip or pulling the trigger when it&rsquo;s out of ammo.</p>

<p>Check out the result and examine it carefully. How cool is that? We are the Kalashnikovs of our age.</p>

<pre><code>&lt;&lt; RIFLE [state=Empty Magazine (No Clip), ammo=0] &gt;&gt;
&gt; You have loaded a clip with 3 bulletts.
&gt; BANG!!!
&gt; Bullet on its way!
&gt; BANG!!!
&gt; Bullet on its way!
&gt; BANG!!!
&gt; Bullet on its way!
&gt; Darn! Out of ammo
!* Click! Out of ammo.
&lt;&lt; RIFLE [state=Out of Ammo, ammo=0] &gt;&amp;#038;g;t
!* You need to take out the empty clip first.
&gt; You have unloaded a clip.
&lt;span class=&quot;yellow&quot;&gt;!* Empty Click! - No clip!&lt;/span&gt;
</code></pre>

<p>Note that I have omitted the <code>toString()</code> method for the <code>Rifle</code>.</p>

<p>Well done! We have our first state machine.</p>

<h4 id="but">But</h4>

<p>We can&rsquo;t do much firing bullet by bullet. We need automatic fire! Oh, and we can&rsquo;t just let people running around with rifles without the safety ON.</p>

<p>Ah, that&rsquo;s easy, right? We&rsquo;ll have a few more states and a few more transitions.</p>

<p>But wait, we will need to rework the <code>Rifle</code> class a bit.</p>

<p>Let&rsquo;s see what we need to modify just to support automatic and manual fire:</p>

<ul>
<li>we need to add the two states</li>
<li>but then we need to modify every single method to handle the states by adding conditional statements</li>
<li><code>pullTrigger()</code> will get complicated as it will need to know what state it is in and check bullets and fire them as such</li>
</ul>

<p>That is a LOT of work. It must be some other way.</p>

<h4 id="the-solution">The Solution</h4>

<p>What if we give each state a behaviour and put it into its own class? This way each state will implement its own actions only. We will have the rifle class delegating the action to the state object that represents the current state.</p>

<p>Let&rsquo;s see how does it look?</p>

<p><img src="/images/archive/2011/03/RifleStateDiagram2-e1301593283605.png" alt="" /></p>

<p>What you should notice is that the <em>Has Clip</em> is now Manual/Auto and has a <em>switch</em> transition. It basically has a sub-state now. Flipping the switch changes the behaviour. Both states will have the <em>pull trigger</em> action but each state will behave differently. This is easily achieved with interfaces, right?</p>

<p>Let&rsquo;s start coding then. First, let&rsquo;s create the state interface. Remember, each state will implement its transition and will provide the dummy implementation for the rest. The interface will contain all the actions. The methods map directly to all the actions that can happen with the <code>Rifle</code></p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">interface</span> <span style="color: #0e84b5; font-weight: bold">RifleState</span> <span style="color: #666666">{</span>

    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">insertClip</span><span style="color: #666666">();</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">ejectClip</span><span style="color: #666666">();</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">swithManualAuto</span><span style="color: #666666">();</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">pullTrigger</span><span style="color: #666666">();</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">fireAmmo</span><span style="color: #666666">();</span>
<span style="color: #666666">}</span>
</pre></div>

<p>The new <code>Rifle</code> class will have none of the implemented actions, but will have all the states and will delegate the actions to its current state.</p>

<p><code>Rifle.java</code></p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">Rifle</span> <span style="color: #666666">{</span>

    <span style="color: #60a0b0; font-style: italic">// the states of the rifle</span>
    RifleState emptyState<span style="color: #666666">;</span>
    RifleState autoFireState<span style="color: #666666">;</span>
    RifleState manualFireState<span style="color: #666666">;</span>
    RifleState outOfAmmoState<span style="color: #666666">;</span>
    RifleState roundFiredState<span style="color: #666666">;</span>
    RifleState ammoFiredState<span style="color: #666666">;</span>
    
    RifleState state <span style="color: #666666">=</span> emptyState<span style="color: #666666">;</span>
    <span style="color: #902000">int</span> ammoCount <span style="color: #666666">=</span> <span style="color: #40a070">0</span><span style="color: #666666">;</span>
    
    <span style="color: #60a0b0; font-style: italic">// constructor</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #06287e">Rifle</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #60a0b0; font-style: italic">// creating states</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">emptyState</span>         <span style="color: #666666">=</span> <span style="color: #007020; font-weight: bold">new</span> NoClipState<span style="color: #666666">(</span><span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">);</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">autoFireState</span>      <span style="color: #666666">=</span> <span style="color: #007020; font-weight: bold">new</span> AutoFireState<span style="color: #666666">(</span><span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">);</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">manualFireState</span>    <span style="color: #666666">=</span> <span style="color: #007020; font-weight: bold">new</span> ManualFireState<span style="color: #666666">(</span><span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">);</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">outOfAmmoState</span>     <span style="color: #666666">=</span> <span style="color: #007020; font-weight: bold">new</span> OutOfAmmoState<span style="color: #666666">(</span><span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">);</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">roundFiredState</span>    <span style="color: #666666">=</span> <span style="color: #007020; font-weight: bold">new</span> RoundFiredState<span style="color: #666666">(</span><span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">);</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">ammoFiredState</span>     <span style="color: #666666">=</span> <span style="color: #007020; font-weight: bold">new</span> AmmoFiredState<span style="color: #666666">(</span><span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">);</span>
        
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">state</span>      <span style="color: #666666">=</span> <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">emptyState</span><span style="color: #666666">;</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">ammoCount</span>  <span style="color: #666666">=</span> <span style="color: #40a070">0</span><span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
    <span style="color: #60a0b0; font-style: italic">// convenience methods - delegating only</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">insertClip</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">state</span><span style="color: #666666">.</span><span style="color: #4070a0">insertClip</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">ejectClip</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">state</span><span style="color: #666666">.</span><span style="color: #4070a0">ejectClip</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">switchManualAuto</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">state</span><span style="color: #666666">.</span><span style="color: #4070a0">switchManualAuto</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">pullTrigger</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">state</span><span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
    
    <span style="color: #60a0b0; font-style: italic">// getters and setters</span>
    <span style="color: #60a0b0; font-style: italic">// ... omitted</span>
<span style="color: #666666">}</span>
</pre></div>

<p>You see that the class has changed a bit. It has all the states and a current state. It has a constructor too. The constructor is needed to set up the rifle and pass itself as a reference to all of the states to give them access to the rifle&rsquo;s properties. In our case just the ammo count and current state need to be accessed.</p>

<p>Also the <code>fireAmmo()</code> is missing as it is a state internal action.</p>

<p>Now let&rsquo;s map the states to actual classes. These are the same as in the original rifle class.</p>

<p>I will list one full class and for the rest only the methods that change the state. Examine the source code for the complete listings.</p>

<p><code>OutOfAmmoState.java</code></p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">OutOfAmmoState</span> <span style="color: #007020; font-weight: bold">implements</span> RifleState <span style="color: #666666">{</span>

    <span style="color: #007020; font-weight: bold">private</span> Rifle rifle<span style="color: #666666">;</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #06287e">OutOfAmmoState</span><span style="color: #666666">(</span>Rifle rifle<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">rifle</span> <span style="color: #666666">=</span> rifle<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>
    
    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">ejectClip</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getEmptyState</span><span style="color: #666666">());</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; Clip ejected.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">fireAmmo</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;!* You can&#39;t fire with no ammo.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">insertClip</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;!* There is an empty clip inserted already!&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">pullTrigger</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;!* Out of ammo!&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">switchManualAuto</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;!* Plesea reload first&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>
</pre></div>

<p>Notice that the only way out of the <em>OutOfAmmoState</em> is by ejecting the clip.</p>

<p>Every other attempt will do nothing.</p>

<p>Also note the constructor. We are passing the reference to the rifle there.</p>

<p>Check out the other classes too:</p>

<p><code>AmmoFiredState</code></p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">AmmoFiredState</span> <span style="color: #007020; font-weight: bold">implements</span> RifleState <span style="color: #666666">{</span>

    <span style="color: #007020; font-weight: bold">private</span> Rifle rifle<span style="color: #666666">;</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #06287e">AmmoFiredState</span><span style="color: #666666">(</span>Rifle rifle<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">rifle</span> <span style="color: #666666">=</span> rifle<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">fireAmmo</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setAmmoCount</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getAmmoCount</span><span style="color: #666666">()</span> <span style="color: #666666">-</span> <span style="color: #40a070">1</span><span style="color: #666666">);</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; Fired 1 bullet.&quot;</span><span style="color: #666666">);</span>
        <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getAmmoCount</span><span style="color: #666666">()</span> <span style="color: #666666">==</span> <span style="color: #40a070">0</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getOutOfAmmoState</span><span style="color: #666666">());</span>
        <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #666666">{</span>
            rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getManualFireState</span><span style="color: #666666">());</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
    <span style="color: #60a0b0; font-style: italic">// ... ommited</span>
<span style="color: #666666">}</span>
</pre></div>

<p><code>AutoFireState</code></p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">AutoFireState</span> <span style="color: #007020; font-weight: bold">implements</span> RifleState <span style="color: #666666">{</span>

    <span style="color: #007020; font-weight: bold">private</span> Rifle rifle<span style="color: #666666">;</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #06287e">AutoFireState</span><span style="color: #666666">(</span>Rifle rifle<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">rifle</span> <span style="color: #666666">=</span> rifle<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">ejectClip</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setAmmoCount</span><span style="color: #666666">(</span><span style="color: #40a070">0</span><span style="color: #666666">);</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getEmptyState</span><span style="color: #666666">());</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; Clip ejected. Please reload.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">pullTrigger</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; Pulled trigger.&quot;</span><span style="color: #666666">);</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getRoundFiredState</span><span style="color: #666666">());</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">getState</span><span style="color: #666666">().</span><span style="color: #4070a0">fireAmmo</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">switchManualAuto</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getManualFireState</span><span style="color: #666666">());</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; Switched to manual. Hope they are slow and few!&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
    <span style="color: #60a0b0; font-style: italic">// ... ommited</span>
<span style="color: #666666">}</span>
</pre></div>

<p>If you follow the diagram then you should be able to figure out the transitions. There is a trick there as the Manual and Auto modes are very similar and I just transition between them. There is a drawback as after a reload, the manual state is the active one even if the auto was set before. But I&rsquo;m sure you can figure out a quick fix.</p>

<p><code>ManualFireState</code></p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">ManualFireState</span> <span style="color: #007020; font-weight: bold">implements</span> RifleState <span style="color: #666666">{</span>
    
    <span style="color: #007020; font-weight: bold">private</span> Rifle rifle<span style="color: #666666">;</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #06287e">ManualFireState</span><span style="color: #666666">(</span>Rifle rifle<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">rifle</span> <span style="color: #666666">=</span> rifle<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">ejectClip</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setAmmoCount</span><span style="color: #666666">(</span><span style="color: #40a070">0</span><span style="color: #666666">);</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getEmptyState</span><span style="color: #666666">());</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; Clip ejected. Please reload.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">pullTrigger</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; Pulled trigger.&quot;</span><span style="color: #666666">);</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getAmmoFiredState</span><span style="color: #666666">());</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">getState</span><span style="color: #666666">().</span><span style="color: #4070a0">fireAmmo</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">switchManualAuto</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getAutoFireState</span><span style="color: #666666">());</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; Switched to auto. Bring&#39;em on!!!&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #60a0b0; font-style: italic">// ... ommited</span>
<span style="color: #666666">}</span>
</pre></div>

<p><code>NoClipState</code></p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">NoClipState</span> <span style="color: #007020; font-weight: bold">implements</span> RifleState <span style="color: #666666">{</span>
    
    <span style="color: #007020; font-weight: bold">private</span> Rifle rifle<span style="color: #666666">;</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #06287e">NoClipState</span><span style="color: #666666">(</span>Rifle rifle<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">rifle</span> <span style="color: #666666">=</span> rifle<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">insertClip</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">ammoCount</span> <span style="color: #666666">=</span> <span style="color: #40a070">50</span><span style="color: #666666">;</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getManualFireState</span><span style="color: #666666">());</span>
    <span style="color: #666666">}</span>

    <span style="color: #60a0b0; font-style: italic">// ...ommited</span>
<span style="color: #666666">}</span>
</pre></div>

<p><code>RoundFiredState</code></p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">RoundFiredState</span> <span style="color: #007020; font-weight: bold">implements</span> RifleState <span style="color: #666666">{</span>

    <span style="color: #007020; font-weight: bold">private</span> Rifle rifle<span style="color: #666666">;</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #06287e">RoundFiredState</span><span style="color: #666666">(</span>Rifle rifle<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #007020; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #4070a0">rifle</span> <span style="color: #666666">=</span> rifle<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #555555; font-weight: bold">@Override</span>
    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #902000">void</span> <span style="color: #06287e">fireAmmo</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #902000">int</span> count <span style="color: #666666">=</span> <span style="color: #40a070">10</span><span style="color: #666666">;</span>
        <span style="color: #007020; font-weight: bold">while</span> <span style="color: #666666">(</span>count <span style="color: #666666">&gt;</span> <span style="color: #40a070">0</span> <span style="color: #666666">&amp;&amp;</span> rifle<span style="color: #666666">.</span><span style="color: #4070a0">getAmmoCount</span><span style="color: #666666">()</span> <span style="color: #666666">&gt;</span> <span style="color: #40a070">0</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">print</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; BANG! &quot;</span><span style="color: #666666">);</span>
            rifle<span style="color: #666666">.</span><span style="color: #4070a0">setAmmoCount</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getAmmoCount</span><span style="color: #666666">()</span> <span style="color: #666666">-</span> <span style="color: #40a070">1</span><span style="color: #666666">);</span>
            count<span style="color: #666666">--;</span>
        <span style="color: #666666">}</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">();</span>
        System<span style="color: #666666">.</span><span style="color: #4070a0">out</span><span style="color: #666666">.</span><span style="color: #4070a0">println</span><span style="color: #666666">(</span><span style="color: #4070a0">&quot;&gt; Fired a round of &quot;</span> <span style="color: #666666">+</span> <span style="color: #666666">(</span><span style="color: #40a070">10</span> <span style="color: #666666">-</span> count<span style="color: #666666">)</span> <span style="color: #666666">+</span> <span style="color: #4070a0">&quot; bullets. Yeah!&quot;</span><span style="color: #666666">);</span>
        <span style="color: #007020; font-weight: bold">if</span> <span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getAmmoCount</span><span style="color: #666666">()</span> <span style="color: #666666">&lt;=</span> <span style="color: #40a070">0</span><span style="color: #666666">)</span> <span style="color: #666666">{</span>
            rifle<span style="color: #666666">.</span><span style="color: #4070a0">setAmmoCount</span><span style="color: #666666">(</span><span style="color: #40a070">0</span><span style="color: #666666">);</span>
            rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getOutOfAmmoState</span><span style="color: #666666">());</span>
        <span style="color: #666666">}</span> <span style="color: #007020; font-weight: bold">else</span> <span style="color: #666666">{</span>
            rifle<span style="color: #666666">.</span><span style="color: #4070a0">setState</span><span style="color: #666666">(</span>rifle<span style="color: #666666">.</span><span style="color: #4070a0">getAutoFireState</span><span style="color: #666666">());</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
    <span style="color: #60a0b0; font-style: italic">// ...ommited</span>
<span style="color: #666666">}</span>
</pre></div>

<p>Great! Let&rsquo;s throw together a test for the new shiny Rifle.</p>

<p><code>RifleTest</code></p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">RifleTest</span> <span style="color: #666666">{</span>

    <span style="color: #007020; font-weight: bold">public</span> <span style="color: #007020; font-weight: bold">static</span> <span style="color: #902000">void</span> <span style="color: #06287e">main</span><span style="color: #666666">(</span>String<span style="color: #666666">[]</span> args<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        Rifle rifle <span style="color: #666666">=</span> <span style="color: #007020; font-weight: bold">new</span> Rifle<span style="color: #666666">();</span>
        
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">ejectClip</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">insertClip</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">switchManualAuto</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">switchManualAuto</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">insertClip</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">switchManualAuto</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
        rifle<span style="color: #666666">.</span><span style="color: #4070a0">pullTrigger</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>
</pre></div>

<p>Examine the output very carefully and go through the source code. You should try adding new features or think of other scenarios.</p>

<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="background-color: #ffffcc">!* You can<span style="border: 1px solid #FF0000">&#39;</span>t fire with an empty magazine.
</span><span style="background-color: #ffffcc">!* The magazine <span style="color: #007020; font-weight: bold">is</span> empty.
</span>&gt; Pulled trigger.
&gt; Fired <span style="color: #40a070">1</span> bullet.
&gt; Switched to auto. Bring<span style="border: 1px solid #FF0000">&#39;</span>em on<span style="color: #666666">!!</span>!
&gt; Pulled trigger.
&gt; BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt; BANG! &gt;BANG! &gt;BANG!
&gt; Fired a round of <span style="color: #40a070">10</span> bullets. Yeah!
&gt; Pulled trigger.
&gt; BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt; BANG! &gt;BANG! &gt;BANG!
&gt; Fired a round of <span style="color: #40a070">10</span> bullets. Yeah!
&gt; Switched to manual. Hope they are slow and few!
&gt; Pulled trigger.
&gt; Fired <span style="color: #40a070">1</span> bullet.
<span style="background-color: #ffffcc">!* Clip <span style="color: #007020; font-weight: bold">is</span> already present!
</span>&gt; Switched to auto. Bring<span style="border: 1px solid #FF0000">&#39;</span>em on<span style="color: #666666">!!</span>!
&gt; Pulled trigger.
&gt; BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt; BANG! &gt;BANG! &gt;BANG!
&gt; Fired a round of <span style="color: #40a070">10</span> bullets. Yeah!
&gt; Pulled trigger.
&gt; BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt; BANG! &gt;BANG! &gt;BANG!
&gt; Fired a round of <span style="color: #40a070">10</span> bullets. Yeah!
&gt; Pulled trigger.
&gt; BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG! &gt;BANG!
&gt; Fired a round of <span style="color: #40a070">8</span> bullets. Yeah!
<span style="background-color: #ffffcc">!* Out of ammo!
</span><span style="background-color: #ffffcc">!* Out of ammo!
</span></pre></div>


<p>Again, the highlighted lines (starting with a bang (!)) show you when you tried something dodgy.</p>

<p>Voila! We have state machines and easily extensible game elements.</p>

<p>I strongly encourage you to extend it and build your own, as it is a very important element of game design.</p>

<p>You can apply this principle for the whole game and infrastructure. Think of the game as a whole and when you&rsquo;re on the menu screen (that&rsquo;s the Menu State), when you&rsquo;re in the paused screen, that&rsquo;s the Pause State, or the main screen that&rsquo;s the Running State. You could create a framework and easily add different game states.</p>

<p>I do hope this gave you a good introduction on how to implement state driven behaviours. Note that I used normal Java practices to write the code for clarity. Meaning that when writing a game, especially for Android, you might not need to overload your classes with <code>getters</code> and <code>setters</code> and you should adhere to the optimized ways. You could use public attributes and access them directly for example. But it was not the scope of this article.</p>

<p>Also understanding this is crucial to make a step towards autonomous agents (automatons). Next time I will introduce event and/or message driven behaviours. We will return to our beloved droids to give them wits to outrun you.</p>

<p>Note that the first attempt was renamed to <code>RifleOld.java</code> and <code>RifleOldTest.java</code></p>
            </div>
            
            <div class="post-comments">
                
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2017 obviam.net -
<span class="credit">
	Powered by 
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and 
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

    </body>
